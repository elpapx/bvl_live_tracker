<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Acciones Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            grid-column: 1 / -1;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: fit-content;
        }
        .stats-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: fit-content;
        }
        .stats-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .stats-card {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .compact-view {
            padding: 15px;
        }
        .compact-view .symbol-title {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .compact-view .price-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }
        .compact-view .current-price {
            font-size: 24px;
        }
        .compact-view .price-meta {
            text-align: left;
        }
        .compact-view .stats-list,
        .compact-view .market-cap {
            display: none;
        }
        .symbol-title {
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 18px;
            color: #2c3e50;
        }
        .stats-list {
            list-style-type: none;
            padding: 0;
            margin: 15px 0 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .stats-list li {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        .stats-label {
            font-weight: 500;
            color: #6c757d;
        }
        .positive {
            color: #28a745;
            font-weight: 600;
        }
        .negative {
            color: #dc3545;
            font-weight: 600;
        }
        canvas {
            max-height: 500px;
            width: 100% !important;
        }
        select, button {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 14px;
            background-color: white;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0069d9;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
            grid-column: 1 / -1;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 25px;
            grid-column: 1 / -1;
            color: #6c757d;
        }
        .checkbox-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .auto-update-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #007bff;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            color: #343a40;
            font-weight: 600;
        }
        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .current-price {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
        }
        .price-meta {
            text-align: right;
        }
        .original-price {
            font-size: 14px;
            color: #6c757d;
            display: block;
        }
        .profitability {
            font-size: 16px;
            font-weight: 600;
        }
        .market-cap {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 15px;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        .update-time {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 15px;
        }
        .price-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            background-color: #f8f9fa;
            color: #495057;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="controls">
            <div class="control-group">
                <label>Período:</label>
                <select id="period">
                    <option value="1d">1 Día</option>
                    <option value="1w" selected>1 Semana</option>
                    <option value="1m">1 Mes</option>
                    <option value="3m">3 Meses</option>
                </select>
            </div>

            <div>
                <label>Acciones:</label>
                <div class="checkbox-container">
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-BAP" value="BAP" checked>
                        <label for="symbol-BAP">BAP</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-BRK-B" value="BRK-B">
                        <label for="symbol-BRK-B">BRK-B</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-ILF" value="ILF">
                        <label for="symbol-ILF">ILF</label>
                    </div>
                </div>
            </div>

            <button onclick="updateCharts()">Actualizar</button>

            <div class="auto-update-toggle">
                <span>Auto-actualizar:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoUpdateToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="loading" class="loading" style="display: none;">
            <div style="margin-bottom: 10px;">Cargando datos...</div>
        </div>

        <div class="chart-container">
            <h3>Evolución de Precios</h3>
            <canvas id="priceChart"></canvas>
        </div>

        <div class="stats-container">
            <h3>Estadísticas</h3>
            <div id="statsGrid" class="stats-grid"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let priceChart;
        let autoUpdateInterval;
        const colors = {
            'BAP': '#007bff',
            'BRK-B': '#28a745',
            'ILF': '#dc3545'
        };

        // Formatear números grandes (modificado para volúmenes sin $)
        function formatNumber(num, isVolume = false) {
            if (!num) return 'N/A';
            const prefix = isVolume ? '' : '$';
            if (num >= 1000000000) {
                return prefix + (num / 1000000000).toFixed(2) + 'B';
            }
            if (num >= 1000000) {
                return prefix + (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return prefix + (num / 1000).toFixed(2) + 'K';
            }
            return prefix + num.toFixed(2);
        }

        // Obtener símbolos seleccionados
        function getSelectedSymbols() {
            const symbols = [];
            if (document.getElementById('symbol-BAP').checked) symbols.push('BAP');
            if (document.getElementById('symbol-BRK-B').checked) symbols.push('BRK-B');
            if (document.getElementById('symbol-ILF').checked) symbols.push('ILF');
            return symbols;
        }

        // Función principal para actualizar los gráficos
        async function updateCharts() {
            const period = document.getElementById('period').value;
            const selectedSymbols = getSelectedSymbols();

            if (selectedSymbols.length === 0) {
                showError('Seleccione al menos una acción');
                return;
            }

            // Mostrar carga
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                const response = await axios.get('/api/timeseries-with-profitability', {
                    params: {
                        symbol: selectedSymbols[0],
                        period: period,
                        compare_all: true
                    }
                });

                if (!response.data?.series?.length) {
                    throw new Error('No se recibieron datos válidos');
                }

                // Filtrar series seleccionadas
                const filteredSeries = response.data.series.filter(serie =>
                    selectedSymbols.includes(serie.symbol));

                renderPriceChart(filteredSeries);
                renderStats(filteredSeries);

                console.log(`Datos actualizados: ${new Date().toLocaleTimeString()}`);

            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar datos: ' + error.message);
                clearCharts();
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Configurar auto-actualización
        function setupAutoUpdate() {
            clearInterval(autoUpdateInterval);

            if (document.getElementById('autoUpdateToggle').checked) {
                autoUpdateInterval = setInterval(updateCharts, 60000); // 60 segundos
                console.log('Auto-actualización activada');
            }
        }

        // Mostrar errores
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Limpiar gráficos
        function clearCharts() {
            document.getElementById('statsGrid').innerHTML = '';
            if (priceChart) {
                priceChart.destroy();
                priceChart = null;
            }
        }

        // Función auxiliar para obtener el texto del período
        function getPeriodText(period) {
            const periods = {
                '1d': '1 Día',
                '1w': '1 Semana',
                '1m': '1 Mes',
                '3m': '3 Meses'
            };
            return periods[period] || period;
        }

        // Renderizar gráfico de precios
        function renderPriceChart(series) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (priceChart) priceChart.destroy();

            const validSeries = series.filter(item => item.data?.length > 0);

            if (validSeries.length === 0) {
                showError('No hay datos para mostrar');
                return;
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: validSeries.map(item => ({
                        label: item.symbol,
                        data: item.data.map(point => ({
                            x: point.timestamp,
                            y: point.price
                        })),
                        borderColor: colors[item.symbol],
                        backgroundColor: colors[item.symbol] + '20',
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'DD/MM/YYYY HH:mm',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'DD/MM',
                                    week: 'DD/MM',
                                    month: 'MMM'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Precio (USD)',
                                color: '#6c757d'
                            },
                            grid: {
                                color: '#f1f1f1'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const dataPoint = dataset.data[context.dataIndex];
                                    const rawData = validSeries.find(s => s.symbol === dataset.label).data[context.dataIndex];

                                    return [
                                        `${dataset.label}: $${dataPoint.y.toFixed(2)}`,
                                        `Apertura: $${rawData.open?.toFixed(2) || 'N/A'}`,
                                        `Mín: $${rawData.day_low?.toFixed(2) || 'N/A'}`,
                                        `Máx: $${rawData.day_high?.toFixed(2) || 'N/A'}`,
                                        `Vol: ${rawData.volume ? formatNumber(rawData.volume, true) : 'N/A'}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Renderizar estadísticas (versión corregida)
        function renderStats(series) {
            const container = document.getElementById('statsGrid');
            container.innerHTML = '';
            const selectedCount = series.length;

            series.forEach(item => {
                if (!item.data?.length) return;

                const lastDataPoint = item.data[item.data.length - 1];
                const lastPrice = lastDataPoint.price;
                const totalReturn = item.current_profitability || 0;
                const marketCap = item.market_cap ? formatNumber(item.market_cap) : 'N/A';
                const peRatio = item.trailing_pe ? item.trailing_pe.toFixed(2) : 'N/A';

                // Corrección para dividend yield (dividir por 100 si es mayor a 100)
                let dividendYield = item.dividend_yield ? item.dividend_yield : 0;
                if (dividendYield > 100) {
                    dividendYield = (dividendYield / 100).toFixed(2) + '%';
                } else {
                    dividendYield = dividendYield.toFixed(2) + '%';
                }

                // Calcular volumen total y promedio (sin signo $)
                const volumes = item.data.map(p => p.volume).filter(v => v);
                const totalVolume = volumes.length > 0 ? formatNumber(volumes.reduce((a, b) => a + b, 0), true) : 'N/A';
                const avgVolume = item.average_volume ? formatNumber(item.average_volume, true) : 'N/A';

                const card = document.createElement('div');
                card.className = `stats-card ${selectedCount > 1 ? 'compact-view' : ''}`;

                // Contenido común para ambas vistas
                card.innerHTML = `
                    <div class="symbol-title" style="color: ${colors[item.symbol]}">
                        ${item.symbol} <span class="price-badge">${getPeriodText(item.period)}</span>
                    </div>
                    <div class="price-header">
                        <div class="current-price">$${lastPrice.toFixed(2)}</div>
                        <div class="price-meta">
                            <span class="original-price">Compra: $${item.original_price?.toFixed(2) || 'N/A'}</span>
                            <span class="profitability ${totalReturn >= 0 ? 'positive' : 'negative'}">
                                ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;

                // Solo mostrar detalles adicionales si hay una sola acción
                if (selectedCount === 1) {
                    card.innerHTML += `
                        <div class="market-cap">Capitalización: ${marketCap}</div>
                        <ul class="stats-list">
                            <li><span class="stats-label">Apertura:</span> $${lastDataPoint.open?.toFixed(2) || 'N/A'}</li>
                            <li><span class="stats-label">Mín día:</span> $${lastDataPoint.day_low?.toFixed(2) || 'N/A'}</li>
                            <li><span class="stats-label">Máx día:</span> $${lastDataPoint.day_high?.toFixed(2) || 'N/A'}</li>
                            <li><span class="stats-label">Volumen total:</span> ${totalVolume}</li>
                            <li><span class="stats-label">Volumen promedio:</span> ${avgVolume}</li>
                            <li><span class="stats-label">P/E Ratio:</span> ${peRatio}</li>
                            <li><span class="stats-label">Dividend Yield:</span> ${dividendYield}</li>
                            <li><span class="stats-label">52 Semanas:</span> ${item.fifty_two_week_range || 'N/A'}</li>
                        </ul>
                    `;
                }

                card.innerHTML += `
                    <div class="update-time">
                        Actualizado: ${new Date().toLocaleTimeString()}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateCharts();
            setupAutoUpdate();
        });

        document.getElementById('autoUpdateToggle').addEventListener('change', setupAutoUpdate);
        document.getElementById('period').addEventListener('change', () => {
            updateCharts();
            setupAutoUpdate();
        });
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateCharts();
                setupAutoUpdate();
            });
        });
    </script>
</body>
</html>