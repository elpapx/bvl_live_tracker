<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Variación de Acciones</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .toggle-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.05);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            transition: 0.2s;
            z-index: 1000;
        }
        .toggle-btn:hover {
          background: rgba(0,0,0,0.1);
        }
        .hide-controls {
          display: none !important;
        }
        .controls {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            grid-column: 1 / -1;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: fit-content;
            position: relative;
        }
        .variation-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease;
        }
        .variation-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .current-variation-display {
            font-size: 24px;
            font-weight: 700;
            color: #202124;
        }
        .variation-change {
            font-size: 14px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .positive-change {
            color: #34a853;
            background-color: rgba(52, 168, 83, 0.1);
        }
        .negative-change {
            color: #ea4335;
            background-color: rgba(234, 67, 53, 0.1);
        }
        .checkbox-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        canvas {
            max-height: 500px;
            width: 100% !important;
        }
        select, button {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 14px;
            background-color: white;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0069d9;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
            grid-column: 1 / -1;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 25px;
            grid-column: 1 / -1;
            color: #6c757d;
        }
        h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            color: #343a40;
            font-weight: 600;
        }

        /* Estilos para los indicadores de mercado */
        .market-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            width: 100%;
        }
        .indicator-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            flex: 1;
            min-width: 150px;
            transition: all 0.2s ease;
        }
        .indicator-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .indicator-label {
            font-size: 12px;
            color: #70757a;
            margin-bottom: 5px;
            font-weight: normal;
            text-transform: uppercase;
        }
        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #202124;
        }

        /* Auto-update toggle */
        .auto-update-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #1a73e8;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Nuevo componente para el resumen de múltiples acciones */
        .stocks-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stock-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .stock-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stock-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stock-symbol {
            font-size: 18px;
            font-weight: 700;
            color: #202124;
        }
        .stock-price {
            font-size: 20px;
            font-weight: 600;
        }
        .stock-metrics {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .metric {
            display: flex;
            flex-direction: column;
        }
        .metric-label {
            font-size: 12px;
            color: #70757a;
        }
        .metric-value {
            font-size: 14px;
            font-weight: 500;
            color: #202124;
        }
        .stock-change-indicator {
            font-size: 14px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* Mejoras para responsividad */
        @media (max-width: 768px) {
            .market-indicators {
                flex-direction: column;
            }
            .indicator-card {
                width: 100%;
            }
            .stocks-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
      <button id="toggle-controls-btn" class="toggle-btn" aria-label="Mostrar u ocultar controles">☰</button>
        <div class="controls">
            <div class="control-group">
                <label>Período:</label>
                <select id="period">
                    <option value="realtime">Tiempo Real</option>
                    <option value="1d">1 Día</option>
                    <option value="1w" selected>1 Semana</option>
                    <option value="1m">1 Mes</option>
                    <option value="3m">3 Meses</option>
                </select>
            </div>

            <div>
                <label>Acciones:</label>
                <div class="checkbox-container">
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-BAP" value="BAP" checked>
                        <label for="symbol-BAP">BAP</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-BRK-B" value="BRK-B">
                        <label for="symbol-BRK-B">BRK-B</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbol-ILF" value="ILF">
                        <label for="symbol-ILF">ILF</label>
                    </div>
                </div>
            </div>

            <button onclick="updateCharts()">Actualizar</button>

            <div class="auto-update-toggle">
                <span>Auto-actualizar:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoUpdateToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="loading" class="loading" style="display: none;">
            <div style="margin-bottom: 10px;">Cargando datos...</div>
        </div>

        <div class="chart-container">
            <!-- Overlay para mostrar la variación sobre el gráfico -->
            <div class="variation-overlay">
                <span class="current-variation-display">+5,18%</span>
                <span class="variation-change positive-change">↑ 9,41% (6 meses)</span>
            </div>
            <canvas id="variationChart"></canvas>
        </div>

        <!-- Indicadores de mercado para una acción seleccionada -->
        <div class="market-indicators" id="singleStockIndicators">
            <div class="indicator-card">
                <div class="indicator-label">CIERRE ANTERIOR</div>
                <div class="indicator-value">193,60 $</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">CAP. BURSÁTIL</div>
                <div class="indicator-value">15,14 mil M USD</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">RELACIÓN P/E</div>
                <div class="indicator-value">10,15</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">VOLUMEN</div>
                <div class="indicator-value">308,72 mil</div>
            </div>
        </div>

        <div class="market-indicators" id="singleStockIndicators2">
            <div class="indicator-card">
                <div class="indicator-label">INTERVALO DIARIO</div>
                <div class="indicator-value">187,29 $ - 192,05 $</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">VOLUMEN MEDIO</div>
                <div class="indicator-value">308,72 mil</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">RENTABILIDAD DIV.</div>
                <div class="indicator-value">4,86 %</div>
            </div>
            <div class="indicator-card">
                <div class="indicator-label">BOLSA PRINCIPAL</div>
                <div class="indicator-value">NYSE</div>
            </div>
        </div>

        <!-- Nuevo componente para mostrar resumen de múltiples acciones -->
        <div class="stocks-summary" id="multipleStocksSummary" style="display: none;">
            <!-- Las tarjetas de resumen se generarán dinámicamente aquí -->
        </div>
    </div>

    <script>
        // Ocultar y mostrar div "controls"
        const toggleBtn = document.getElementById('toggle-controls-btn');
        const controls = document.querySelector('.controls');

        toggleBtn.addEventListener('click', () => {
          const isHidden = controls.classList.toggle('hide-controls');
          // cambiamos icono: ☰ = abrir, × = cerrar
          toggleBtn.textContent = isHidden ? '☰' : '×';
          // opcionalmente actualizas aria-expanded:
          toggleBtn.setAttribute('aria-expanded', String(!isHidden));
        });
        // Variables globales
        let variationChart;
        let autoUpdateInterval;
        const colors = {
            'BAP': '#007bff',
            'BRK-B': '#28a745',
            'ILF': '#dc3545'
        };

        // Formatear números grandes (modificado para volúmenes sin $)
        function formatNumber(num, isVolume = false) {
            if (!num) return 'N/A';
            const prefix = isVolume ? '' : '$';
            if (num >= 1000000000) {
                return prefix + (num / 1000000000).toFixed(2) + 'B';
            }
            if (num >= 1000000) {
                return prefix + (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return prefix + (num / 1000).toFixed(2) + 'K';
            }
            return prefix + num.toFixed(2);
        }

        // Obtener símbolos seleccionados
        function getSelectedSymbols() {
            const symbols = [];
            if (document.getElementById('symbol-BAP').checked) symbols.push('BAP');
            if (document.getElementById('symbol-BRK-B').checked) symbols.push('BRK-B');
            if (document.getElementById('symbol-ILF').checked) symbols.push('ILF');
            return symbols;
        }

        // Obtener el cierre anterior confiable
        function getPreviousClose(series) {
            if (!series || !series.data || series.data.length === 0) return null;

            // Intentar obtener el cierre anterior directamente del último punto de datos
            const lastPoint = series.data[series.data.length - 1];
            if (lastPoint && lastPoint.previous_close) {
                return lastPoint.previous_close;
            }

            // Si no está disponible, intentar obtener del primer punto (que podría contener el cierre anterior)
            const firstPoint = series.data[0];
            if (firstPoint && firstPoint.previous_close) {
                return firstPoint.previous_close;
            }

            // Como última alternativa, si hay más de un punto, usar el precio del penúltimo punto
            if (series.data.length > 1) {
                return series.data[series.data.length - 2].price;
            }

            //
            return 193.60;
        }

        // Función principal para actualizar los gráficos
        async function updateCharts() {
            const period = document.getElementById('period').value;
            const selectedSymbols = getSelectedSymbols();

            if (selectedSymbols.length === 0) {
                showError('Seleccione al menos una acción');
                return;
            }

            // Mostrar/ocultar overlay según cantidad de acciones seleccionadas
            const variationOverlay = document.querySelector('.variation-overlay');
            if (selectedSymbols.length > 1) {
                variationOverlay.classList.add('hidden');
            } else {
                variationOverlay.classList.remove('hidden');
            }

            // Mostrar carga
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                // Usar el endpoint timeseries-with-profitability con el parámetro is_variation=true
                const response = await axios.get('/api/timeseries-with-profitability', {
                    params: {
                        symbol: selectedSymbols[0],
                        period: period,
                        compare_all: true,
                        is_variation: true  // Esto indica que queremos datos de variación
                    }
                });

                if (!response.data?.series?.length) {
                    throw new Error('No se recibieron datos válidos');
                }

                // Filtrar series seleccionadas
                const filteredSeries = response.data.series.filter(serie =>
                    selectedSymbols.includes(serie.symbol) && serie.data?.length > 0);

                if (filteredSeries.length == 0) {
                    throw new Error('No hay datos para los simbolos seleccionados');
                }

                renderVariationChart(filteredSeries);

                // Manejamos la vista según la cantidad de símbolos seleccionados
                if (selectedSymbols.length === 1) {
                    // Para un solo símbolo, mostramos indicadores detallados
                    updateVariationOverlay(filteredSeries[0]);
                    updateSingleStockIndicators(filteredSeries[0]);
                    document.getElementById('singleStockIndicators').style.display = 'flex';
                    document.getElementById('singleStockIndicators2').style.display = 'flex';
                    document.getElementById('multipleStocksSummary').style.display = 'none';
                } else {
                    // Para múltiples símbolos, mostramos resumen comparativo
                    document.getElementById('singleStockIndicators').style.display = 'none';
                    document.getElementById('singleStockIndicators2').style.display = 'none';
                    document.getElementById('multipleStocksSummary').style.display = 'grid';
                    updateMultipleStocksSummary(filteredSeries);
                }

                console.log(`Datos actualizados: ${new Date().toLocaleTimeString()}`);

            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar datos: ' + error.message);
                clearCharts();
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Función para actualizar el overlay de la variación
        function updateVariationOverlay(series) {
            if (!series || !series.data || series.data.length === 0) return;

            const lastDataPoint = series.data[series.data.length - 1];
            const variationElement = document.querySelector('.current-variation-display');
            const changeElement = document.querySelector('.variation-change');

            if (variationElement && lastDataPoint) {
                // Mostrar la última variación en el overlay
                variationElement.textContent = (lastDataPoint.price >= 0 ? '+' : '') + lastDataPoint.price.toFixed(2) + '%';
                variationElement.style.color = lastDataPoint.price >= 0 ? '#34a853' : '#ea4335';
            }

            if (changeElement && series.current_profitability !== undefined) {
                const isPositive = series.current_profitability >= 0;
                changeElement.className = `variation-change ${isPositive ? 'positive-change' : 'negative-change'}`;
                const sign = isPositive ? '↑' : '↓';
                const periodText = getPeriodText(document.getElementById('period').value);
                changeElement.textContent = `${sign} ${Math.abs(series.current_profitability).toFixed(2)}% ${isPositive ? '+' : ''}${periodText}`;
            }
        }

        // Actualizar indicadores para un solo stock
        function updateSingleStockIndicators(series) {
            if (!series || !series.data || series.data.length === 0) return;

            const lastDataPoint = series.data[series.data.length - 1];

            // Obtener cierre anterior de manera confiable
            const prevClose = getPreviousClose(series);

            // Actualizar el cierre anterior
            document.querySelector('#singleStockIndicators .indicator-card:nth-child(1) .indicator-value').textContent =
                prevClose ? `${prevClose.toFixed(2)} $` : 'N/A';

            // Capitalización de mercado
            const marketCap = series.market_cap ? formatNumber(series.market_cap) : 'N/A';

            // P/E Ratio
            const peRatio = series.trailing_pe ? series.trailing_pe.toFixed(2) : 'N/A';

            // Volumen actual
            const volume = lastDataPoint.volume ? formatNumber(lastDataPoint.volume, true) : 'N/A';

            document.querySelector('#singleStockIndicators .indicator-card:nth-child(2) .indicator-value').textContent = marketCap;
            document.querySelector('#singleStockIndicators .indicator-card:nth-child(3) .indicator-value').textContent = peRatio;
            document.querySelector('#singleStockIndicators .indicator-card:nth-child(4) .indicator-value').textContent = volume;

            // Segunda fila de indicadores
            // Encontrar mínimo y máximo en los datos disponibles
            const dayLows = series.data.map(d => d.day_low).filter(Boolean);
            const dayHighs = series.data.map(d => d.day_high).filter(Boolean);

            const min = dayLows.length > 0 ? Math.min(...dayLows) : (series.current_price * 0.98).toFixed(2);
            const max = dayHighs.length > 0 ? Math.max(...dayHighs) : (series.current_price * 1.02).toFixed(2);

            document.querySelector('#singleStockIndicators2 .indicator-card:nth-child(1) .indicator-value').textContent =
                `${typeof min === 'number' ? min.toFixed(2) : min} $ - ${typeof max === 'number' ? max.toFixed(2) : max} $`;

            // Calcular volumen promedio
            const volumes = series.data.map(p => {
                return p.volume || (p.volume === 0 ? 0 : null);
            }).filter(v => v !== null && v !== undefined && !isNaN(v));

            const avgVolume = volumes.length > 0
                ? formatNumber(volumes.reduce((a, b) => a + b, 0) / volumes.length, true)
                : 'N/A';

            document.querySelector('#singleStockIndicators2 .indicator-card:nth-child(2) .indicator-value').textContent = avgVolume;

            // Dividend Yield
            let dividendYield = series.dividend_yield ? series.dividend_yield : 0;
            if (dividendYield > 100) {
                dividendYield = (dividendYield / 100).toFixed(2) + '%';
            } else {
                dividendYield = dividendYield.toFixed(2) + '%';
            }
            document.querySelector('#singleStockIndicators2 .indicator-card:nth-child(3) .indicator-value').textContent = dividendYield;

            // Bolsa principal (ejemplo)
            const exchange = 'NYSE';
            document.querySelector('#singleStockIndicators2 .indicator-card:nth-child(4) .indicator-value').textContent = exchange;
        }

        // Nueva función para mostrar resumen de múltiples acciones
        function updateMultipleStocksSummary(series) {
            const container = document.getElementById('multipleStocksSummary');
            container.innerHTML = ''; // Limpiar el contenedor

            series.forEach(stock => {
                if (!stock.data || stock.data.length === 0) return;

                const lastPoint = stock.data[stock.data.length - 1];
                const isPositive = lastPoint.price >= 0;

                // Obtener cierre anterior de manera confiable para cada acción
                const previousClose = getPreviousClose(stock);

                const stockCard = document.createElement('div');
                stockCard.className = 'stock-card';

                stockCard.innerHTML = `
                    <div class="stock-header">
                        <div class="stock-symbol">${stock.symbol}</div>
                        <div class="stock-price" style="color: ${isPositive ? '#34a853' : '#ea4335'}">
                            ${(lastPoint.price >= 0 ? '+' : '') + lastPoint.price.toFixed(2)}%
                        </div>
                    </div>
                    <div style="padding: 10px 15px; background-color: ${isPositive ? 'rgba(52, 168, 83, 0.1)' : 'rgba(234, 67, 53, 0.1)'}">
                        <span class="stock-change-indicator" style="color: ${isPositive ? '#34a853' : '#ea4335'}">
                            ${isPositive ? '↑' : '↓'} ${Math.abs(stock.daily_variation).toFixed(2)}%
                        </span>
                    </div>
                    <div class="stock-metrics">
                        <div class="metric">
                            <div class="metric-label">PRECIO ACTUAL</div>
                            <div class="metric-value">${stock.current_price ? stock.current_price.toFixed(2) + ' $' : 'N/A'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">CIERRE ANT.</div>
                            <div class="metric-value">${previousClose ? previousClose.toFixed(2) + ' $' : 'N/A'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">VOLATILIDAD</div>
                            <div class="metric-value">${stock.volatility.toFixed(2)}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">RENTABILIDAD</div>
                            <div class="metric-value">${stock.current_profitability ? stock.current_profitability.toFixed(2) + '%' : 'N/A'}</div>
                        </div>
                    </div>
                `;

                container.appendChild(stockCard);
            });
        }

        // Función para renderizar el gráfico de variación
        function renderVariationChart(series) {
            const ctx = document.getElementById('variationChart').getContext('2d');
            if (variationChart) variationChart.destroy();

            const period = document.getElementById('period').value;
            const isDailyView = period === '1w' || period === '1m' || period === '3m';
            const isOneDayView = period === '1d';
            const isRealTimeView = period === 'realtime';

            variationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: series.map(item => {
                        // Configuración para vista de 1 día
                        if (isOneDayView) {
                            // Obtener el último punto del día anterior
                            const now = new Date();
                            const yesterday = new Date(now);
                            yesterday.setDate(yesterday.getDate() - 1);
                            const yesterdayKey = `${yesterday.getFullYear()}-${yesterday.getMonth()}-${yesterday.getDate()}`;

                            // Buscar el último punto del día anterior
                            let yesterdayPoint = null;
                            for (let i = item.data.length - 1; i >= 0; i--) {
                                const pointDate = new Date(item.data[i].timestamp);
                                const pointKey = `${pointDate.getFullYear()}-${pointDate.getMonth()}-${pointDate.getDate()}`;
                                if (pointKey === yesterdayKey) {
                                    yesterdayPoint = item.data[i];
                                    break;
                                }
                            }

                            // Si no hay punto del día anterior, usar el primer punto disponible
                            if (!yesterdayPoint && item.data.length > 0) {
                                yesterdayPoint = item.data[0];
                            }

                            // Obtener el último punto (punto actual)
                            const currentPoint = item.data[item.data.length - 1];

                            // Crear dataset con solo dos puntos: día anterior y actual
                            const dataPoints = [
                                yesterdayPoint ? {
                                    x: yesterdayPoint.timestamp,
                                    y: yesterdayPoint.price,
                                    rawData: yesterdayPoint
                                } : null,
                                currentPoint ? {
                                    x: currentPoint.timestamp,
                                    y: currentPoint.price,
                                    rawData: currentPoint
                                } : null
                            ].filter(point => point !== null);

                            return {
                                label: item.symbol,
                                data: dataPoints,
                                borderColor: colors[item.symbol],
                                backgroundColor: colors[item.symbol] + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                pointRadius: 3,
                                fill: false
                            };
                        }
                        // Configuración para vista en tiempo real
                        else if (isRealTimeView) {
                            // Filtrar puntos solo para las horas de mercado (9 AM - 4 PM)
                            const marketHoursData = item.data.filter(point => {
                                const pointDate = new Date(point.timestamp);
                                const hours = pointDate.getHours();
                                return hours >= 9 && hours <= 16; // 9 AM to 4 PM
                            });

                            return {
                                label: item.symbol,
                                data: marketHoursData.map(point => ({
                                    x: point.timestamp,
                                    y: point.price,
                                    rawData: point
                                })),
                                borderColor: colors[item.symbol],
                                backgroundColor: colors[item.symbol] + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            };
                        }
                        // Configuración para vistas diarias (semana, mes, 3 meses)
                        else {
                            return {
                                label: item.symbol,
                                data: isDailyView ?
                                    getDailyPoints(item.data) :
                                    item.data.map(point => ({
                                        x: point.timestamp,
                                        y: point.price,
                                        rawData: point
                                    })),
                                borderColor: colors[item.symbol],
                                backgroundColor: colors[item.symbol] + '20',
                                tension: 0.1,
                                borderWidth: 2,
                                pointRadius: isDailyView ? 3 : 0,
                                fill: false
                            };
                        }
                    })
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: isRealTimeView ? 'DD/MM/YYYY HH:mm' :
                                              (isDailyView ? 'DD/MM/YYYY' : 'DD/MM/YYYY HH:mm'),
                                displayFormats: {
                                    hour: (isDailyView || isOneDayView) ? 'DD/MM' : 'HH:mm',
                                    day: 'DD/MM',
                                    week: 'DD/MM',
                                    month: 'MMM'
                                },
                                unit: isDailyView ? 'day' : undefined
                            },
                            grid: {
                                display: false
                            },
                            title: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: false
                            },
                            grid: {
                                color: '#f1f1f1'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const dataPoint = dataset.data[context.dataIndex];
                                    const rawData = isRealTimeView ?
                                        dataPoint.rawData :
                                        (isDailyView ?
                                            context.dataset.rawData[context.dataIndex] :
                                            series.find(s => s.symbol === dataset.label).data[context.dataIndex]);

                                    return [
                                        `${dataset.label}: ${(dataPoint.y >= 0 ? '+' : '') + dataPoint.y.toFixed(2)}%`,
                                        rawData.open ? `Apertura: $${rawData.open.toFixed(2)}` : null,
                                        rawData.day_low ? `Mín: $${rawData.day_low.toFixed(2)}` : null,
                                        rawData.day_high ? `Máx: $${rawData.day_high.toFixed(2)}` : null,
                                        rawData.volume ? `Vol: ${formatNumber(rawData.volume, true)}` : null
                                    ].filter(line => line !== null);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Función auxiliar para obtener un punto por día (el último de cada día)
        function getDailyPoints(data) {
            const dailyPoints = [];
            const daysMap = new Map();

            // Agrupar puntos por día
            data.forEach(point => {
                const date = new Date(point.timestamp);
                const dayKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;

                if (!daysMap.has(dayKey) ||
                    new Date(point.timestamp) > new Date(daysMap.get(dayKey).timestamp)) {
                    daysMap.set(dayKey, point);
                }
            });

            // Convertir el mapa a array de puntos
            daysMap.forEach(point => {
                dailyPoints.push({
                    x: point.timestamp,
                    y: point.price,
                    rawData: point // Guardamos los datos originales para el tooltip
                });
            });

            return dailyPoints;
        }

        // Configurar auto-actualización
        function setupAutoUpdate() {
            clearInterval(autoUpdateInterval);

            if (document.getElementById('autoUpdateToggle').checked) {
                const period = document.getElementById('period').value;
                const updateInterval = period === 'realtime' ? 10000 : 60000; // 10 segundos en tiempo real, 60 segundos en otros modos
                autoUpdateInterval = setInterval(updateCharts, updateInterval);
                console.log(`Auto-actualización activada (${updateInterval/1000}s)`);
            }
        }

        // Mostrar errores
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Limpiar gráficos
        function clearCharts() {
            if (variationChart) {
                variationChart.destroy();
                variationChart = null;
            }
            document.getElementById('singleStockIndicators').style.display = 'none';
            document.getElementById('singleStockIndicators2').style.display = 'none';
            document.getElementById('multipleStocksSummary').style.display = 'none';
        }

        // Función auxiliar para obtener el texto del período
        function getPeriodText(period) {
            const periods = {
                'realtime': 'tiempo real',
                '1d': '1 día',
                '1w': '1 semana',
                '1m': '1 mes',
                '3m': '3 meses'
            };
            return periods[period] || period;
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateCharts();
            setupAutoUpdate();
        });

        document.getElementById('autoUpdateToggle').addEventListener('change', setupAutoUpdate);
        document.getElementById('period').addEventListener('change', () => {
            updateCharts();
            setupAutoUpdate();
        });
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateCharts();
                setupAutoUpdate();
            });
        });
    </script>
</body>
</html>